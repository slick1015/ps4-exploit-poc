const express = require("express");
const fs = require('fs');
const path = require('path');

const app = express();

app.use("/", express.static("dist"));
app.use(express.urlencoded({extended: true}));

app.post("/debug/log", (req, res) => {
    var msg = "";
    req.on("data", (chunk) => {
        msg += chunk.toString();
    });
    req.on("end", () => {
        console.log("[PS4] " + msg);
        res.sendStatus(200);
    });
});

// app.post("/debug/file", (req, res) => {
//     var data = "";
//     req.on("data", (chunk) => {
//         data += chunk;
//     });
//     req.on("end", () => {
//         console.log("received file");
//         console.log(data);
//         let final = new Buffer.from(data, 'base64');
//         fs.writeFileSync("./upload.bin", final);
//         res.sendStatus(200);
//     });
// });

app.post('/debug/file', function (req, res) {
    let name = 'dumps/' + req.get('Content-Disposition').replace(':', '');
    console.log("receiving file: " + name)
	let dir = path.dirname(name);

	// try {
	// 	fs.statSync(dir);
	// } catch (e) {
	// 	fs.mkdirSync(dir);
    // }
    
	req.pipe(fs.createWriteStream(name, {
		defaultEncoding: 'binary',
		flags: 'a'
	}));

	req.on('end', function() {
		return res.sendStatus(200);
	});
});

app.listen(80);
